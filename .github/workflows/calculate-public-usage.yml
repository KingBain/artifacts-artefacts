# .github/workflows/calculate-public-usage.yml
name: Calculate Usage

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

permissions: read-all

jobs:
  count_repos:
    runs-on: ubuntu-latest

    steps:
      - name: Create App token
        id: create_token
        uses: actions/create-github-app-token@3ff1caaa28b64c9cc276ce0a02e2ff584f3900c5 # v2
        with:
          app-id: ${{ vars.ARTIFACTS_ARTEFACTS_CODE_BOT_ID }}
          private-key: ${{ secrets.ARTIFACTS_ARTEFACTS_CODE_BOT_KEY }}
          owner: ${{ github.repository_owner }}
          repositories: ${{ github.event.repository.name }}
          permission-contents: write

      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.create_token.outputs.token }}
          ref: ${{ github.ref_name }}

      - name: Count unique repos referencing JF_URL
        env:
          GH_TOKEN: ${{ steps.create_token.outputs.token }}
        run: |
          # Capture current date in YYYY-MM-DD (UTC)
          current_date=$(date -u +%Y-%m-%d)

          # Run the GitHub Code Search API, extract repo names, dedupe, and count
          count=$(
            curl -sSL \
              -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/search/code?q=%22JF_URL%3A+https%3A%2F%2Fartifacts-artefacts.devops.cloud-nuage.canada.ca%22+language%3AYAML+path%3A.github%2Fworkflows%2F" \
            | jq -r '.items[].repository.full_name' \
            | sort -u \
            | wc -l
          )

          echo "Date: $current_date"
          echo "Unique repos found: $count"

          # Ensure data directory exists
          mkdir -p stats

          # Define the CSV file path
          file="stats/usage.csv"

          # If the file doesn't exist, add a header
          if [ ! -f "$file" ]; then
            echo "date,count" > "$file"
          fi

          # Append today's date and the count
          echo "$current_date,$count" >> "$file"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install plotting dependencies
        run: |
          pip install pandas matplotlib

      - name: Generate XKCD-style usage graph
        run: |
          python3 scripts/generate_graph.py

      - name: Commit and Push Changes
        env:
          GITHUB_TOKEN: ${{ steps.create_token.outputs.token }}
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git config --global user.name "ðŸ¤– Artifacts-Artefacts Code Bot"
            git config --global user.email "<${{ vars.ARTIFACTS_ARTEFACTS_CODE_BOT_ID }}+Artifacts-Artefacts Code[bot]@users.noreply.github.com>"
            git add stats/usage.csv stats/usage.png
            git commit -m "Add usage for $(date -u +%Y-%m-%d): ${{ steps.count_repos.outputs.count }}"
            git push
          else
            echo "No changes to commit."
          fi